<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>小羅盤｜管理導航系統</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
--bg:#D8DCDD;
--line:#C8C0BE;
--accent:#F6D494;
}
body{
background:var(--bg);
font-family:'Zen Maru Gothic', sans-serif;
}
.hard-shadow{
box-shadow:4px 4px 0 var(--line);
border:2px solid var(--line);
}
.page{display:none;min-height:100vh;}
.page.active{display:block;}
.title-font{font-weight:900;}
.pill-search{
border-radius:9999px;
padding:12px 20px;
border:2px solid var(--line);
}
.bottom-btn{
position:fixed;
bottom:20px;
left:50%;
transform:translateX(-50%);
width:90%;
max-width:500px;
padding:16px;
background:var(--accent);
font-weight:900;
border-radius:20px;
}
</style>
</head>

<body class="pb-24">

<nav id="top-nav" class="hidden sticky top-0 bg-white/80 backdrop-blur p-4 flex items-center border-b">
<button onclick="goBack()" class="hard-shadow px-3 py-1 bg-white">←</button>
<span id="nav-title" class="ml-4 font-black"></span>
</nav>

<!-- 首頁 -->
<div id="home" class="page active p-6">
<h1 class="text-4xl title-font mb-6">小羅盤</h1>

<div class="grid grid-cols-2 gap-4">

<div class="col-span-2 bg-[#F6D494] p-6 rounded-3xl hard-shadow cursor-pointer"
onclick="openPage('daily','今日行程')">
<h2 class="title-font">今日行程</h2>
<div id="live-task" class="text-xl mt-2"></div>
</div>

<div class="bg-white p-5 rounded-3xl hard-shadow cursor-pointer"
onclick="openPage('yearly','年度行程')">年度行程</div>

<div class="bg-white p-5 rounded-3xl hard-shadow cursor-pointer"
onclick="openPage('crisis','危機處理')">危機處理</div>

<div class="bg-white p-5 rounded-3xl hard-shadow cursor-pointer"
onclick="openPage('resources','資源外聯')">資源外聯</div>

<div class="bg-white p-5 rounded-3xl hard-shadow cursor-pointer"
onclick="openPage('parents','紅綠燈檔案')">紅綠燈檔案</div>

</div>

<div class="mt-8">
<input placeholder="搜尋家長/學生..."
class="pill-search w-full"
oninput="searchParents(this.value)">
</div>

</div>

<!-- 今日行程頁 -->
<div id="daily" class="page p-6">
<h2 class="title-font text-2xl mb-4">現在該做什麼？</h2>
<div id="daily-content" class="text-lg leading-relaxed"></div>
</div>

<!-- 其他頁面佔位 -->
<div id="yearly" class="page p-6">年度行程（待擴充）</div>
<div id="crisis" class="page p-6">危機處理（待擴充）</div>
<div id="resources" class="page p-6">資源外聯（待擴充）</div>

<!-- 紅綠燈 -->
<div id="parents" class="page p-6">
<div id="parent-list"></div>
<button onclick="addParent()" class="bottom-btn hard-shadow">
＋ 新增檔案
</button>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyCnVZJgRZc7fid3FZCZeGXchFBrTywTgF8",
authDomain: "cram-school-app-86ef7.firebaseapp.com",
projectId: "cram-school-app-86ef7",
storageBucket: "cram-school-app-86ef7.firebasestorage.app",
messagingSenderId: "169123409521",
appId: "1:169123409521:web:96b8bbb8ab31c94c64b5d0",
measurementId: "G-BE0M81JC1T"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.addParent = async function(){
const name=prompt("學生姓名");
const color=prompt("red/yellow/green");
await addDoc(collection(db,"parents"),{name,color});
loadParents();
}

async function loadParents(){
const snap=await getDocs(collection(db,"parents"));
let html="";
snap.forEach(d=>{
const p=d.data();
html+=`
<div class="hard-shadow p-4 bg-white mb-3 rounded-xl">
${p.name} (${p.color})
<button onclick="deleteParent('${d.id}')">刪除</button>
</div>`;
});
document.getElementById("parent-list").innerHTML=html;
}
window.deleteParent=async function(id){
await deleteDoc(doc(db,"parents",id));
loadParents();
}
loadParents();
</script>

<script>
let historyStack=["home"];

function openPage(id,title){
document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
document.getElementById(id).classList.add("active");
document.getElementById("top-nav").classList.remove("hidden");
document.getElementById("nav-title").innerText=title||"";
historyStack.push(id);
}

function goBack(){
historyStack.pop();
const prev=historyStack.pop();
document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
document.getElementById(prev).classList.add("active");
}

/* 今日行程邏輯 */

function getTodaySchedule() {
    const now = new Date();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const totalMinutes = hour * 60 + minute;
    const day = now.getDay(); // 5=週五

    function between(sh, sm, eh, em){
        const start = sh*60+sm;
        const end = eh*60+em;
        return totalMinutes >= start && totalMinutes < end;
    }

    if (between(0,0,12,30)) return "休息時間";

    if (between(12,30,13,0)) {
        return `① 打掃騎樓<br>
        ② 確認孩子都有進班，若未通知未出現，記得訊息通知家長`;
    }

    if (between(13,0,13,30)) return "整理今日待辦事項";

    if (between(14,0,16,0)) {
        let text="行政工作";
        if(day===5) text+="<br>＋準備下週晚餐單";
        return text;
    }

    if (between(16,0,16,30)) {
        return `① 準備點心<br>
        ② 確認孩子都有進班，若未通知未出現，記得訊息通知家長<br>
        ③ 提醒老師傳當日晚餐單`;
    }

    if (hour===16 && minute>=30 && minute<40) return "訂晚餐";

    if (hour===16 && minute>=40 && minute<60) return "倒垃圾";

    if (between(17,0,20,0)) {
        return `① 叫學生回家<br>
        ② 行政工作<br>
        ③ 打掃`;
    }

    if (between(20,0,20,30)) {
        return `① 晚餐費用、零用金清點<br>
        ② 隔日待辦事項記錄`;
    }

    if (between(20,30,23,59)) return "休息時間";

    return "—";
}

function tick(){
const content=getTodaySchedule();
document.getElementById("live-task").innerHTML=content;
document.getElementById("daily-content").innerHTML=content;
}

tick();
setInterval(tick,60000);

function searchParents(keyword){
const cards=document.querySelectorAll("#parent-list div");
cards.forEach(c=>{
c.style.display=c.innerText.includes(keyword)?"block":"none";
});
}
</script>

</body>
</html>
